@using System.Globalization
@using System.Text
@using Hotello.Common
@using Hotello.Services.Expedia.Hotels.Models
@model PagedList.IPagedList<HotelSummary>

@{
    ViewBag.Title = "Hotel Results";
    var culture = new CultureInfo("en-GB");
    const string googleApiKey = "AIzaSyDm7lXUQTaEvPo-eghcFIo2VjJvyKawKUo";
}

@section css {
    @Styles.Render("~/Content/rateit.css")
}

<div class="well">
    
    <h2>Hotel Search Results</h2>
    
    <div class="pagination"> 
        <ul>
            
            @if (Model.HasPreviousPage)
            {
                <li>@Html.ActionLink("<<", "Results", new {page = 1})</li>
                <li>@Html.ActionLink("<", "Results", new {page = Model.PageNumber - 1})</li>
            }
            else
            {
                <li class="disabled"><span>&lt;</span></li>
                <li class="disabled"><span>&lt;&lt;</span></li>
            }
            

            @for (int i = 1; i <= Model.PageCount; i++)
            {
                <li class="@(i == Model.PageNumber ? "active" : "")">
                    @Html.ActionLink(i.ToString(CultureInfo.InvariantCulture), "Results", new { page = i })
                </li>
            }
            
            @if (Model.HasNextPage)
            {
                <li>
                    @Html.ActionLink(">", "Results", new { page = Model.PageNumber + 1 })
                </li>
                <li>
                    @Html.ActionLink(">>", "Results", new { page = Model.PageCount })
                </li>
            }
            else
            {
                <li class="disabled"><span>&gt;</span></li>
                <li class="disabled"><span>&gt;&gt;</span></li>
            }

        </ul>
    </div>

    @foreach (var hotel in Model.OrEmptyIfNull())
    {
        <div class="well" style="background-color: white">
        
            <!-- Hotel Name and expedia star rating -->
            <div class="row">
                <div class="span12">
                    <span title="@hotel.HotelId"><b>@Server.HtmlDecode(hotel.Name)</b></span>
                    <div class="rateit" data-rateit-value="@hotel.HotelRating" data-rateit-min="0" data-rateit-ispreset="true" data-rateit-readonly="true"></div>
                </div>
            </div>
            
            <!-- Hotel Properties -->
            <div class="row row-hotel-info">
            
                <!-- Thumbnail -->
                <div class="span1">
                    <img class="img-rounded" width="150" height="150" alt="Hotel Thumbnail" src="@string.Format(@"http://images.travelnow.com/{0}", hotel.ThumbNailUrl)" title="@hotel.HotelId" />
                    <p>
                        <a class="hidden" href="@hotel.DeepLink">Deep Link</a>
                    </p>
                </div>
            
                <!-- Address -->
                <div class="span2">
                    <span class="label label-info"><i class="icon-home"></i> Address</span> <span class="label label-info"><i class="icon-plane"></i> @hotel.AirportCode</span>
                    <address>
                        @hotel.Address1<br/>
                        @hotel.Address2<br/>
                        @hotel.City<br/>
                        @hotel.PostalCode<br/>
                    </address>
                    <p>
                        <!-- ADDITIONAL -->
                    </p>
                </div>
                
                <!-- Short Description -->
                <div class="span2" title="Click on Hotel Details to view more...">
                    @Html.Raw(Server.HtmlDecode(hotel.ShortDescription)) ...
                </div>
                
                <!-- Google Map -->
                <div class="span2">
                    <p>
                        @{
                            var url = new StringBuilder()
                                .Append("http://maps.googleapis.com/maps/api/staticmap?")
                                .Append(string.Format("center={0},{1}", hotel.Latitude, hotel.Longitude))
                                .Append(string.Format("&zoom=15&size=150x150&sensor=false"))
                                .Append(string.Format("&key={0}", googleApiKey))
                                .Append("&markers=").Append(Server.UrlEncode(string.Format("size:small|color:blue|{0},{1}", hotel.Latitude, hotel.Longitude)))
                                .ToString();
                        }

                        <img title="@hotel.Latitude, @hotel.Longitude" src="@url" alt="Google Map" class="img-rounded" height="150" width="150" />
                    </p>
                </div>

                <!-- Hotel Price / Info Link -->
                <div class="span4">
                    
                    <div class="row">
                        
                        <!-- POPULAR AMENITIES TO SHOW -->
                        <div class="pull-left">
                            <ul class="unstyled">
                                @foreach (var amenity in hotel.Amenities.GetFlags().ToList())
                                {
                                    <li>
                                        <span><i class="icon-ok-sign"></i> @amenity.GetDescription()</span>
                                    </li>
                                }
                            </ul>
                        </div>
                        
                        <!-- PRICE RATES -->
                        <div class="pull-right">
                            
                            <span>From</span>
                            <h4><span>@culture.NumberFormat.CurrencySymbol</span>@hotel.HighRate.ToString("0.##")<small> per night</small></h4>

                        </div>

                    </div>

                    <div class="row">
                        
                        <div class="span2">
                            <!-- HOTEL GALLERY AJAX CALL -->
                            <a href="#gallery" id="@hotel.HotelId" data-toggle="modal" class="btn btn-small btn-info btn-block">
                                <i class="icon-camera"></i> Photo Gallery
                            </a>  
                        </div>
                            
                        <div class="span2">
                            <!-- DETAILS LINK -->
                            <a href="@Url.Action("Information", "Hotels", new RouteValueDictionary { { "id", hotel.HotelId } })" class="btn btn-small btn-info btn-block">
                                <span>Hotel Details </span><i class="icon-arrow-right"></i>
                            </a>
                        </div>
                    
                    </div>
                </div>
             
            </div>   
        
        </div>  
    }
    <!-- End Hotel Results -->

    <!-- Paging -->
    @if (Session["CacheKey"] != null && Session["CacheLocation"] != null && Session["MoreResultsAvailable"] != null)
    {
        bool moreResults = Session["MoreResultsAvailable"] is bool && (bool)Session["MoreResultsAvailable"];

        if (!Model.HasNextPage && moreResults)
        {
            <!-- GET MORE RESULTS -->
            <a class="btn btn-primary" href="@Url.Action("Results", new { cacheKey = Session["CacheKey"], cacheLocation = Session["CacheLocation"], page = Model.PageNumber + 1 })">
                <i class="icon-search"></i> More Results Available!
            </a>
        }
    }
    
    <div class="pagination">
        
        <ul>
           @if (Model.HasPreviousPage)
            {
                <li>@Html.ActionLink("<<", "Results", new {page = 1})</li>
                <li>@Html.ActionLink("<", "Results", new {page = Model.PageNumber - 1})</li>
            }
            else
            {
                <li class="disabled"><span>&lt;</span></li>
                <li class="disabled"><span>&lt;&lt;</span></li>
            }
            

            @for (int i = 1; i <= Model.PageCount; i++)
            {
                <li class="@(i == Model.PageNumber ? "active" : "")">
                    @Html.ActionLink(i.ToString(CultureInfo.InvariantCulture), "Results", new { page = i })
                </li>
            }
            
            @if (Model.HasNextPage)
            {
                <li>
                    @Html.ActionLink(">", "Results", new { page = Model.PageNumber + 1 })
                </li>
                <li>
                    @Html.ActionLink(">>", "Results", new { page = Model.PageCount })
                </li>
            }
            else
            {
                <li class="disabled"><span>&gt;</span></li>
                <li class="disabled"><span>&gt;&gt;</span></li>
            }
        </ul>
    </div>
</div>



<!-- HOTEL GALLERY MODAL -->
<div id="gallery" class="modal hide fade" tabindex="-1" role="dialog">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>Hotel Gallery</h3>
    </div>
    <div class="modal-body">
        <div id="myCarousel" class="carousel slide">
            <div class="carousel-inner">
            </div>
            <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
            <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
</div>

@section scripts { 
    
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/bundles/jqueryrateit")
    <script type="text/javascript">
        
        /*
         http://stackoverflow.com/questions/13391566/twitter-bootstrap-carousel-different-height-images-cause-bouncing-arrows    
         
         */

        $(document).ready(function() {

            // Rate it Initilization
            $('.rateit').rateit();

            // Register Click event
            $("a[href='#gallery']").click(function () {

                $.ajax({
                    url: '@Url.Action("Images", "Hotels")', // MVC Action
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        id: $(this).attr('id')
                    },
                    success: function(data) {
                        $('.carousel-inner').html(''); // Clear any previous content, i.e from clicking on another hotel gallery
                        $.map(data, function(item) {
                            var html =
                                "<div class='item hotel-image'>" +
                                    "<img alt='' title='" + item.name + "' src='" + item.Url + "' class='img-polaroid hotel-image' style='float:none; margin-left: auto; margin-right: auto;' />" +
                                    "<div class='carousel-caption'>" +
                                    "<h4>" + (item.caption != "" ?  item.Caption : "") + "</h4>" +
                                    "</div>" +
                                    "</div>";

                            $('.carousel-inner').append(html);
                            
                            $('.item').find('h4').each(function() {
                                if ($(this).val() === "") {
                                    $(this).parent('.carousel-caption').hide(); // nothing to show...
                                }
                                    
                            });
                        });

                        $('.carousel-inner div.item:first').attr('class', 'item active');
                        $('div#gallery').modal('show');
                        $('.carousel').carousel();
                    }
                });
            });
        });

    </script>

}